<scroll-view class="page" scroll-y="true">
  <view class="header">
    <view class="title">中药智能分析与推荐</view>
    <view class="subtitle">依据《开发监督规范》，整合体检数据与问卷信息生成个性化方案</view>
  </view>

  <view class="card">
    <view class="card-title">体检报告上传（可选）</view>
    <view class="upload-area" bindtap="handleUpload">
      <text>+ 选择体检报告图片</text>
      <view class="hint">支持 JPG / PNG，单次最多 6 张</view>
    </view>
    <view class="upload-status" wx:if="{{uploadStatus}}">{{uploadStatus}}</view>
    <view class="upload-list" wx:if="{{uploadFiles && uploadFiles.length}}">
      <view class="upload-item" wx:for="{{uploadFiles || []}}" wx:key="uploadTime">
        <image class="upload-thumb" src="{{item.tempFilePath}}" mode="aspectFill" />
        <view class="upload-remove" data-index="{{index}}" bindtap="removeUploaded">×</view>
      </view>
    </view>
  </view>

  <view class="card">
    <view class="card-title">基础信息</view>
    <view class="section">
      <view class="field">
        <view class="label">性别</view>
        <radio-group class="radio-group" data-section="demographics" data-key="gender" bindchange="onRadioChange">
          <label class="radio-item">
            <radio value="male" checked="{{form.demographics.gender === 'male'}}" /> 男
          </label>
          <label class="radio-item">
            <radio value="female" checked="{{form.demographics.gender === 'female'}}" /> 女
          </label>
        </radio-group>
      </view>
      <view class="field-grid">
        <view class="field">
          <view class="label">年龄</view>
          <input type="number" placeholder="岁" value="{{form.demographics.age}}" data-path="form.demographics.age" bindinput="onInputChange" />
        </view>
        <view class="field">
          <view class="label">身高</view>
          <input type="number" placeholder="cm" value="{{form.demographics.height}}" data-path="form.demographics.height" bindinput="onInputChange" />
        </view>
        <view class="field">
          <view class="label">体重</view>
          <input type="number" placeholder="kg" value="{{form.demographics.weight}}" data-path="form.demographics.weight" bindinput="onInputChange" />
        </view>
      </view>
    </view>
  </view>


  <view class="card">
    <view class="card-title">病史与生活方式</view>
    <view class="section">
      <view class="label">既往或特殊情况</view>
      <view class="option-group">
        <view
          class="option-chip {{form.historyChecked && form.historyChecked[item.value] ? 'checked' : ''}}"
          wx:for="{{historyOptions || []}}"
          wx:key="value"
          data-section="history"
          data-value="{{item.value}}"
          bindtap="toggleOption"
        >
          <text class="option-icon" wx:if="{{form.historyChecked && form.historyChecked[item.value]}}">✔</text>
          <text class="option-label">{{item.label}}</text>
        </view>
      </view>
    </view>

    <view class="section lifestyle">
      <view class="label">生活方式</view>
      <view class="lifestyle-group" wx:for="{{lifestyleGroups || []}}" wx:key="key">
        <view class="lifestyle-title">{{item.title}}</view>
        <radio-group data-section="lifestyle" data-key="{{item.key}}" bindchange="onRadioChange">
          <label class="radio-item" wx:for="{{item.options || []}}" wx:for-item="option" wx:key="value">
            <radio value="{{option.value}}" checked="{{form.lifestyle[item.key] === option.value}}" /> {{option.label}}
          </label>
        </radio-group>
      </view>
    </view>
  </view>

  <view class="card">
    <view class="card-title">主要诉求</view>
    <view class="option-group">
      <view
        class="option-chip {{form.symptomsChecked && form.symptomsChecked[item.value] ? 'checked' : ''}}"
        wx:for="{{symptomOptions || []}}"
        wx:key="value"
        data-section="symptoms"
        data-value="{{item.value}}"
        bindtap="toggleOption"
      >
        <text class="option-icon" wx:if="{{form.symptomsChecked && form.symptomsChecked[item.value]}}">✔</text>
        <text class="option-label">{{item.label}}</text>
      </view>
    </view>
  </view>

  <view class="card">
    <view class="card-title">中医体质问卷（0 = 不符合，4 = 非常符合）</view>
    <view class="tcm-grid">
      <view class="tcm-item" wx:for="{{tcmDimensions || []}}" wx:key="key">
        <view class="tcm-header">
          <view class="tcm-label">{{item.label}}</view>
          <view class="tcm-value">{{form.tcmQuiz[item.key]}}</view>
        </view>
        <view class="tcm-desc">{{item.description}}</view>
        <slider min="0" max="4" step="1" show-value="false" value="{{form.tcmQuiz[item.key]}}" data-key="{{item.key}}" bindchange="onTcmSliderChange" />
      </view>
    </view>
  </view>

  <view class="card actions">
    <button class="primary" bindtap="submitAnalysis" loading="{{isSubmitting}}" disabled="{{isSubmitting}}">提交分析</button>
    <button class="secondary" bindtap="resetForm" disabled="{{isSubmitting}}">重置表单</button>
  </view>
  <view class="analysis-wrapper" wx:if="{{analysisResult}}">
    <view class="analysis-banner">
      <view class="banner-top">
        <view class="banner-title">AI 体质分析完成</view>
        <view class="banner-score">{{similarityText}}</view>
      </view>
      <view class="banner-tags">
        <view class="banner-chip">{{analysisResult.tcmPattern || '待确认'}}</view>
        <view class="banner-chip">{{analysisResult.constitution || '待确认'}}</view>
        <view class="banner-chip severity-{{analysisResult.severityClass || 'neutral'}}">{{analysisResult.severity || '需评估'}}</view>
      </view>
      <view class="banner-desc">{{analysisResult.summary || '系统已根据您的体检资料生成调理建议，请结合专业医师意见使用。'}}</view>
    </view>

    <view class="pretty-section" wx:if="{{analysisResult.topCustomHerbs && analysisResult.topCustomHerbs.length}}">
      <view class="section-header">
        <view class="section-icon">🌿</view>
        <view class="section-title">{{analysisResult.topSampleTitle || '样本药方'}}</view>
      </view>
      <view class="section-card">
        <view class="pill-grid">
          <view class="pill" wx:for="{{analysisResult.topCustomHerbs}}" wx:key="name">
            <view class="pill-name">{{item.name}}</view>
            <view class="pill-dose">{{item.amount}}{{item.unit}}</view>
            <view class="pill-effect" wx:if="{{item.effect}}">{{item.effect}}</view>
          </view>
        </view>
      </view>
    </view>

    <view class="pretty-section" wx:if="{{analysisResult.lifestyleAdvice.length}}">
      <view class="section-header">
        <view class="section-icon">💡</view>
        <view class="section-title">生活方式建议</view>
      </view>
      <view class="section-card">
        <view class="advice-list">
          <view class="advice-chip" wx:for="{{analysisResult.lifestyleAdvice}}" wx:key="*this">{{item}}</view>
        </view>
      </view>
    </view>

    <view class="pretty-section" wx:if="{{analysisResult.safety}}">
      <view class="section-header">
        <view class="section-icon">🛡️</view>
        <view class="section-title">安全提示</view>
      </view>
      <view class="section-card">
        <view class="safety-banner safety-{{analysisResult.safety.riskLevelClass || 'neutral'}}">
          <view class="safety-level">{{analysisResult.safety.riskLevel || '请遵医嘱'}}</view>
          <view class="safety-desc">{{analysisResult.safety.isSafe ? '总体风险较低，请在医师指导下持续观察。' : '发现潜在风险，请先咨询执业中医师后再决定是否使用本方案。'}}</view>
        </view>

        <view class="bullet-section danger" wx:if="{{analysisResult.safety.alerts.length}}">
          <view class="bullet-title">重点关注</view>
          <view class="bullet-list">
            <view class="bullet-item" wx:for="{{analysisResult.safety.alerts}}" wx:key="*this">{{item}}</view>
          </view>
        </view>

        <view class="bullet-section notice" wx:if="{{analysisResult.safety.disclaimers.length}}">
          <view class="bullet-title">温馨提示</view>
          <view class="bullet-list">
            <view class="bullet-item" wx:for="{{analysisResult.safety.disclaimers}}" wx:key="*this">{{item}}</view>
          </view>
        </view>
      </view>
    </view>
  </view>
</scroll-view>
