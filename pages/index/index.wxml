<scroll-view class="page" scroll-y="true">
  <view class="header">
    <view class="title">ä¸­è¯æ™ºèƒ½åˆ†æä¸æ¨è</view>
    <view class="subtitle">ä¾æ®ã€Šå¼€å‘ç›‘ç£è§„èŒƒã€‹ï¼Œæ•´åˆä½“æ£€æ•°æ®ä¸é—®å·ä¿¡æ¯ç”Ÿæˆä¸ªæ€§åŒ–æ–¹æ¡ˆ</view>
  </view>

  <view class="card">
    <view class="card-title">ä½“æ£€æŠ¥å‘Šä¸Šä¼ ï¼ˆå¯é€‰ï¼‰</view>
    <view class="upload-area" bindtap="handleUpload">
      <text>+ é€‰æ‹©ä½“æ£€æŠ¥å‘Šå›¾ç‰‡</text>
      <view class="hint">æ”¯æŒ JPG / PNGï¼Œå•æ¬¡æœ€å¤š 6 å¼ </view>
    </view>
    <view class="upload-status" wx:if="{{uploadStatus}}">{{uploadStatus}}</view>
    <view class="upload-list" wx:if="{{uploadFiles && uploadFiles.length}}">
      <view class="upload-item" wx:for="{{uploadFiles || []}}" wx:key="uploadTime">
        <image class="upload-thumb" src="{{item.tempFilePath}}" mode="aspectFill" />
        <view class="upload-remove" data-index="{{index}}" bindtap="removeUploaded">Ã—</view>
      </view>
    </view>
  </view>

  <view class="card">
    <view class="card-title">åŸºç¡€ä¿¡æ¯</view>
    <view class="section">
      <view class="field">
        <view class="label">æ€§åˆ«</view>
        <radio-group class="radio-group" data-section="demographics" data-key="gender" bindchange="onRadioChange">
          <label class="radio-item">
            <radio value="male" checked="{{form.demographics.gender === 'male'}}" /> ç”·
          </label>
          <label class="radio-item">
            <radio value="female" checked="{{form.demographics.gender === 'female'}}" /> å¥³
          </label>
        </radio-group>
      </view>
      <view class="field-grid">
        <view class="field">
          <view class="label">å¹´é¾„</view>
          <input type="number" placeholder="å²" value="{{form.demographics.age}}" data-path="form.demographics.age" bindinput="onInputChange" />
        </view>
        <view class="field">
          <view class="label">èº«é«˜</view>
          <input type="number" placeholder="cm" value="{{form.demographics.height}}" data-path="form.demographics.height" bindinput="onInputChange" />
        </view>
        <view class="field">
          <view class="label">ä½“é‡</view>
          <input type="number" placeholder="kg" value="{{form.demographics.weight}}" data-path="form.demographics.weight" bindinput="onInputChange" />
        </view>
      </view>
    </view>
  </view>


  <view class="card">
    <view class="card-title">ç—…å²ä¸ç”Ÿæ´»æ–¹å¼</view>
    <view class="section">
      <view class="label">æ—¢å¾€æˆ–ç‰¹æ®Šæƒ…å†µ</view>
      <view class="option-group">
        <view
          class="option-chip {{form.historyChecked && form.historyChecked[item.value] ? 'checked' : ''}}"
          wx:for="{{historyOptions || []}}"
          wx:key="value"
          data-section="history"
          data-value="{{item.value}}"
          bindtap="toggleOption"
        >
          <text class="option-icon" wx:if="{{form.historyChecked && form.historyChecked[item.value]}}">âœ”</text>
          <text class="option-label">{{item.label}}</text>
        </view>
      </view>
    </view>

    <view class="section lifestyle">
      <view class="label">ç”Ÿæ´»æ–¹å¼</view>
      <view class="lifestyle-group" wx:for="{{lifestyleGroups || []}}" wx:key="key">
        <view class="lifestyle-title">{{item.title}}</view>
        <radio-group data-section="lifestyle" data-key="{{item.key}}" bindchange="onRadioChange">
          <label class="radio-item" wx:for="{{item.options || []}}" wx:for-item="option" wx:key="value">
            <radio value="{{option.value}}" checked="{{form.lifestyle[item.key] === option.value}}" /> {{option.label}}
          </label>
        </radio-group>
      </view>
    </view>
  </view>

  <view class="card">
    <view class="card-title">ä¸»è¦è¯‰æ±‚</view>
    <view class="option-group">
      <view
        class="option-chip {{form.symptomsChecked && form.symptomsChecked[item.value] ? 'checked' : ''}}"
        wx:for="{{symptomOptions || []}}"
        wx:key="value"
        data-section="symptoms"
        data-value="{{item.value}}"
        bindtap="toggleOption"
      >
        <text class="option-icon" wx:if="{{form.symptomsChecked && form.symptomsChecked[item.value]}}">âœ”</text>
        <text class="option-label">{{item.label}}</text>
      </view>
    </view>
  </view>

  <view class="card">
    <view class="card-title">ä¸­åŒ»ä½“è´¨é—®å·ï¼ˆ0 = ä¸ç¬¦åˆï¼Œ4 = éå¸¸ç¬¦åˆï¼‰</view>
    <view class="tcm-grid">
      <view class="tcm-item" wx:for="{{tcmDimensions || []}}" wx:key="key">
        <view class="tcm-header">
          <view class="tcm-label">{{item.label}}</view>
          <view class="tcm-value">{{form.tcmQuiz[item.key]}}</view>
        </view>
        <view class="tcm-desc">{{item.description}}</view>
        <slider min="0" max="4" step="1" show-value="false" value="{{form.tcmQuiz[item.key]}}" data-key="{{item.key}}" bindchange="onTcmSliderChange" />
      </view>
    </view>
  </view>

  <view class="card actions">
    <button class="primary" bindtap="submitAnalysis" loading="{{isSubmitting}}" disabled="{{isSubmitting}}">æäº¤åˆ†æ</button>
    <button class="secondary" bindtap="resetForm" disabled="{{isSubmitting}}">é‡ç½®è¡¨å•</button>
  </view>
  <view class="analysis-wrapper" wx:if="{{analysisResult}}">
    <view class="analysis-banner">
      <view class="banner-top">
        <view class="banner-title">AI ä½“è´¨åˆ†æå®Œæˆ</view>
        <view class="banner-score">{{similarityText}}</view>
      </view>
      <view class="banner-tags">
        <view class="banner-chip">{{analysisResult.tcmPattern || 'å¾…ç¡®è®¤'}}</view>
        <view class="banner-chip">{{analysisResult.constitution || 'å¾…ç¡®è®¤'}}</view>
        <view class="banner-chip severity-{{analysisResult.severityClass || 'neutral'}}">{{analysisResult.severity || 'éœ€è¯„ä¼°'}}</view>
      </view>
      <view class="banner-desc">{{analysisResult.summary || 'ç³»ç»Ÿå·²æ ¹æ®æ‚¨çš„ä½“æ£€èµ„æ–™ç”Ÿæˆè°ƒç†å»ºè®®ï¼Œè¯·ç»“åˆä¸“ä¸šåŒ»å¸ˆæ„è§ä½¿ç”¨ã€‚'}}</view>
    </view>

    <view class="pretty-section" wx:if="{{analysisResult.topCustomHerbs && analysisResult.topCustomHerbs.length}}">
      <view class="section-header">
        <view class="section-icon">ğŸŒ¿</view>
        <view class="section-title">{{analysisResult.topSampleTitle || 'æ ·æœ¬è¯æ–¹'}}</view>
      </view>
      <view class="section-card">
        <view class="pill-grid">
          <view class="pill" wx:for="{{analysisResult.topCustomHerbs}}" wx:key="name">
            <view class="pill-name">{{item.name}}</view>
            <view class="pill-dose">{{item.amount}}{{item.unit}}</view>
            <view class="pill-effect" wx:if="{{item.effect}}">{{item.effect}}</view>
          </view>
        </view>
      </view>
    </view>

    <view class="pretty-section" wx:if="{{analysisResult.lifestyleAdvice.length}}">
      <view class="section-header">
        <view class="section-icon">ğŸ’¡</view>
        <view class="section-title">ç”Ÿæ´»æ–¹å¼å»ºè®®</view>
      </view>
      <view class="section-card">
        <view class="advice-list">
          <view class="advice-chip" wx:for="{{analysisResult.lifestyleAdvice}}" wx:key="*this">{{item}}</view>
        </view>
      </view>
    </view>

    <view class="pretty-section" wx:if="{{analysisResult.safety}}">
      <view class="section-header">
        <view class="section-icon">ğŸ›¡ï¸</view>
        <view class="section-title">å®‰å…¨æç¤º</view>
      </view>
      <view class="section-card">
        <view class="safety-banner safety-{{analysisResult.safety.riskLevelClass || 'neutral'}}">
          <view class="safety-level">{{analysisResult.safety.riskLevel || 'è¯·éµåŒ»å˜±'}}</view>
          <view class="safety-desc">{{analysisResult.safety.isSafe ? 'æ€»ä½“é£é™©è¾ƒä½ï¼Œè¯·åœ¨åŒ»å¸ˆæŒ‡å¯¼ä¸‹æŒç»­è§‚å¯Ÿã€‚' : 'å‘ç°æ½œåœ¨é£é™©ï¼Œè¯·å…ˆå’¨è¯¢æ‰§ä¸šä¸­åŒ»å¸ˆåå†å†³å®šæ˜¯å¦ä½¿ç”¨æœ¬æ–¹æ¡ˆã€‚'}}</view>
        </view>

        <view class="bullet-section danger" wx:if="{{analysisResult.safety.alerts.length}}">
          <view class="bullet-title">é‡ç‚¹å…³æ³¨</view>
          <view class="bullet-list">
            <view class="bullet-item" wx:for="{{analysisResult.safety.alerts}}" wx:key="*this">{{item}}</view>
          </view>
        </view>

        <view class="bullet-section notice" wx:if="{{analysisResult.safety.disclaimers.length}}">
          <view class="bullet-title">æ¸©é¦¨æç¤º</view>
          <view class="bullet-list">
            <view class="bullet-item" wx:for="{{analysisResult.safety.disclaimers}}" wx:key="*this">{{item}}</view>
          </view>
        </view>
      </view>
    </view>
  </view>
</scroll-view>
